<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Health Logs | AI Health Monitor</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    .table-wrapper {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      background: white;
      margin-top: 10px;
    }
    .vitals-grid {
      display: flex;
      gap: 20px;
    }
    .vital-box {
      background: #fff;
      padding: 10px;
      border-radius: 10px;
      flex: 1;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .back-btn {
      margin: 10px;
      padding: 5px 15px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <button class="back-btn" onclick="window.location.href='dashboard.html'">‚Üê Back</button>

  <div class="dashboard-container">
    <aside class="sidebar">
      <h2 class="logo">AI<span>Health</span></h2>
      <nav class="nav-links">
        <a href="./dashboard.html"><img src="dashboard.png" class="nav-icon"> Dashboard</a>
        <a href="./healthlogs.html" class="active">üìã Health Logs</a>
        <a href="./settings.html">‚öôÔ∏è Settings</a>
        <a href="./device.html">üîå Device</a>
        <a href="./ai-assistant.html">
          <img src="chatbot.jpg" style="width:24px; height:24px; border-radius:50%; vertical-align:middle;">
          AlertoBot
        </a>
        <a href="./about.html">‚ÑπÔ∏è About</a>
        <a href="./signin.html">üö™ Logout</a>
      </nav>
    </aside>

    <main class="main-content">
      <header class="dashboard-header">
        <h1>Health Logs</h1>
        <p>Your recent monitoring records from ESP32 sensor</p>
      </header>

      <section class="live-vitals">
        <h2>üì° Latest Reading</h2>
        <div class="vitals-grid">
          <div class="vital-box"><h3>‚ù§Ô∏è Heart Rate</h3><p id="live-heart-rate">‚Äî</p></div>
          <div class="vital-box"><h3>üå¨Ô∏è SpO‚ÇÇ</h3><p id="live-spo2">‚Äî</p></div>
          <div class="vital-box"><h3>üïí Timestamp</h3><p id="live-timestamp">‚Äî</p></div>
        </div>
      </section>

      <section class="logs-section">
        <h2>üìã Recent Health Records</h2>
        <button id="refresh-btn">üîÑ Refresh</button>

        <div class="table-wrapper">
          <table class="logs-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>‚ù§Ô∏è Heart Rate</th>
                <th>üå¨Ô∏è SpO‚ÇÇ</th>
              </tr>
            </thead>
            <tbody id="health-log-body">
              <tr><td colspan="4" style="text-align:center; padding:15px;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

<script>
const FLASK_URL = "https://semimaterialistic-hyperbolic-laverne.ngrok-free.dev";
const token = localStorage.getItem("access_token");
const tableBody = document.getElementById("health-log-body");
const refreshBtn = document.getElementById("refresh-btn");

// -------------------------------
// Philippine Time Formatter
// -------------------------------
function formatPHDateTime(ts) {
  if (!ts) return { date: "‚Äî", time: "‚Äî" };
  const d = new Date(ts);
  const optionsDate = { year: "numeric", month: "2-digit", day: "2-digit", timeZone: "Asia/Manila" };
  const optionsTime = { hour: "2-digit", minute: "2-digit", second: "2-digit", hour12: false, timeZone: "Asia/Manila" };
  return {
    date: d.toLocaleDateString("en-CA", optionsDate),
    time: d.toLocaleTimeString("en-GB", optionsTime)
  };
}

// -------------------------------
// Render Table Row
// -------------------------------
function renderRow(r) {
  const t = formatPHDateTime(r.timestamp);
  return `
    <tr>
      <td>${t.date}</td>
      <td>${t.time}</td>
      <td>${r.heart_rate ?? "‚Äî"}</td>
      <td>${r.spo2 ?? "‚Äî"}</td>
    </tr>`;
}

// -------------------------------
// Update Latest Reading
// -------------------------------
function updateLatestVitals(records) {
  if (!records.length) return;
  const r = records[0];
  document.getElementById("live-heart-rate").textContent = r.heart_rate ?? "‚Äî";
  document.getElementById("live-spo2").textContent = r.spo2 ?? "‚Äî";
  document.getElementById("live-timestamp").textContent = formatPHDateTime(r.timestamp).time;
}

// -------------------------------
// Fetch Wrapper
// -------------------------------
async function fetchJSON(url, options = {}) {
  options.headers = {
    ...(options.headers || {}),
    "ngrok-skip-browser-warning": "true"
  };
  try {
    const res = await fetch(url, options);
    const text = await res.text();
    return { ok: res.ok, data: JSON.parse(text) };
  } catch (err) {
    console.error("‚ùå NGROK returned HTML or invalid JSON:", err);
    return { ok: false, error: "Invalid JSON from server" };
  }
}

// -------------------------------
// Load Health Logs
// -------------------------------
async function loadHealthLogs() {
  if (!token) {
    tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">‚ö†Ô∏è You must log in first.</td></tr>`;
    return;
  }

  const { ok, data, error } = await fetchJSON(`${FLASK_URL}/healthlogs`, {
    method: "GET",
    headers: { "Authorization": `Bearer ${token}` }
  });

  if (!ok) {
    tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">‚ùå Error loading logs<br><small>${error}</small></td></tr>`;
    return;
  }

  if (!Array.isArray(data) || data.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">üì≠ No records found.</td></tr>`;
    return;
  }

  tableBody.innerHTML = data.map(renderRow).join("");
  updateLatestVitals(data);
}

// -------------------------------
// Event Listeners
// -------------------------------
refreshBtn.addEventListener("click", loadHealthLogs);
loadHealthLogs();
setInterval(loadHealthLogs, 5000);
</script>

<script src="logout.js"></script>
</body>
</html>
