<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Health Logs | AI Health Monitor</title>
  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />

  <style>
    .table-wrapper {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      background: white;
      margin-top: 10px;
    }
    .vitals-grid {
      display: flex;
      gap: 20px;
    }
    .vital-box {
      background: #fff;
      padding: 10px;
      border-radius: 10px;
      flex: 1;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .back-btn {
      margin: 10px;
      padding: 5px 15px;
      cursor: pointer;
    }
    .nav-icon {
      width: 20px;
      vertical-align: middle;
      margin-right: 5px;
    }
    /* Real-time indicator */
    .realtime-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.8);
      color: #0f0;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-family: monospace;
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .realtime-indicator .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #0f0;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    .new-row {
      animation: highlight 2s;
    }
    @keyframes highlight {
      0% { background-color: #ffffcc; }
      100% { background-color: transparent; }
    }
  </style>
</head>
<body>

  <button class="back-btn" onclick="window.location.href='dashboard.html'">â† Back</button>

  <!-- Real-time Indicator -->
  <div class="realtime-indicator" id="realtime-indicator">
    <div class="dot"></div>
    <span id="status-text">Checking...</span>
  </div>

  <div class="dashboard-container">
    <aside class="sidebar">
      <h2 class="logo">BELGIUM<span>sys</span></h2>
      <nav class="nav-links">
        <a href="./dashboard.html"><img src="dashboard.png" class="nav-icon"> Dashboard</a>
        <a href="./healthlogs.html" class="active">ğŸ“‹ Health Logs</a>
        <a href="./settings.html">âš™ï¸ Settings</a>
        <a href="./device.html">ğŸ”Œ Device</a>
        <a href="./ai-assistant.html">
          <img src="chatbot.jpg" style="width:24px; height:24px; border-radius:50%; vertical-align:middle;">
          AlertoBot
        </a>
        <a href="./about.html">â„¹ï¸ About</a>
        <a href="./signin.html">ğŸšª Logout</a>
      </nav>
    </aside>

    <main class="main-content">
      <header class="dashboard-header">
        <h1>Health Logs</h1>
        <p>Your recent monitoring records from ESP32 sensor</p>
      </header>

      <section class="live-vitals">
        <h2>ğŸ“¡ Latest Reading</h2>
        <div class="vitals-grid">
          <div class="vital-box"><h3>â¤ï¸ Heart Rate</h3><p id="live-heart-rate">â€”</p></div>
          <div class="vital-box"><h3>ğŸŒ¬ï¸ SpOâ‚‚</h3><p id="live-spo2">â€”</p></div>
          <div class="vital-box"><h3>ğŸ•’ Timestamp</h3><p id="live-timestamp">â€”</p></div>
        </div>
      </section>

      <section class="logs-section">
        <h2>ğŸ“‹ Recent Health Records</h2>
        <button id="refresh-btn">ğŸ”„ Refresh Now</button>

        <div class="table-wrapper">
          <table class="logs-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Date</th>
                <th>Time</th>
                <th>â¤ï¸ Heart Rate</th>
                <th>ğŸŒ¬ï¸ SpOâ‚‚</th>
              </tr>
            </thead>
            <tbody id="health-log-body">
              <tr><td colspan="5" style="text-align:center; padding:15px;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

<script>
const FLASK_URL = "https://semimaterialistic-hyperbolic-laverne.ngrok-free.dev";
const token = localStorage.getItem("access_token");
const tableBody = document.getElementById("health-log-body");
const refreshBtn = document.getElementById("refresh-btn");

let pollInterval = null;
let lastRecordId = null;
let pollCount = 0;
let knownRecordIds = new Set();

const realtimeIndicator = document.getElementById("realtime-indicator");
const statusText = document.getElementById("status-text");

// Update status
function updateStatus(status) {
  statusText.textContent = status;
}

// Format date/time
function formatDateTime(ts) {
  if (!ts) return { date: "â€”", time: "â€”" };
  try {
    const utcDate = new Date(ts);
    const options = {
      timeZone: "Asia/Manila",
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
      hour12: false
    };
    const formatter = new Intl.DateTimeFormat("en-PH", options);
    const parts = formatter.formatToParts(utcDate);
    const date = `${parts.find(p => p.type === "year").value}-${parts.find(p => p.type === "month").value}-${parts.find(p => p.type === "day").value}`;
    const time = `${parts.find(p => p.type === "hour").value}:${parts.find(p => p.type === "minute").value}:${parts.find(p => p.type === "second").value}`;
    return { date, time };
  } catch {
    return { date: "â€”", time: "â€”" };
  }
}

// Render table row
function renderRow(r, isNew = false) {
  const t = formatDateTime(r.timestamp);
  const rowClass = isNew ? 'class="new-row"' : '';
  return `
    <tr ${rowClass} data-id="${r.id}">
      <td>${r.id}</td>
      <td>${t.date}</td>
      <td>${t.time}</td>
      <td>${r.heart_rate ?? "â€”"}</td>
      <td>${r.spo2 ?? "â€”"}</td>
    </tr>`;
}

// Update latest vitals display
function updateLatestVitals(records) {
  if (!records.length) return;
  const r = records[0];
  document.getElementById("live-heart-rate").textContent = r.heart_rate ?? "â€”";
  document.getElementById("live-spo2").textContent = r.spo2 ?? "â€”";
  document.getElementById("live-timestamp").textContent = formatDateTime(r.timestamp).time;
}

// Fetch with cache bypass
async function fetchJSON(url, options = {}) {
  options.headers = {
    ...(options.headers || {}),
    "ngrok-skip-browser-warning": "true"
  };
  
  // Force cache bypass
  const randomParam = Math.random().toString(36).substring(7);
  const cacheBuster = url.includes('?') ? `&_r=${randomParam}` : `?_r=${randomParam}`;
  const finalUrl = url + cacheBuster;
  
  try {
    const res = await fetch(finalUrl, {
      ...options,
      cache: 'no-store',
      headers: options.headers
    });
    const text = await res.text();
    return { ok: res.ok, data: JSON.parse(text) };
  } catch (err) {
    console.error("Fetch error:", err);
    return { ok: false, error: err.message };
  }
}

// â­ Load health logs with change detection
async function loadHealthLogs() {
  pollCount++;
  updateStatus(`Checking... (${pollCount})`);
  
  if (!token) {
    tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">âš ï¸ You must log in first.</td></tr>`;
    return;
  }

  const { ok, data, error } = await fetchJSON(`${FLASK_URL}/healthlogs`, {
    method: "GET",
    headers: { "Authorization": `Bearer ${token}` }
  });

  if (!ok) {
    tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">âŒ› Error loading logs<br><small>${error}</small></td></tr>`;
    updateStatus("Error");
    return;
  }

  if (!Array.isArray(data) || data.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">ğŸ”­ No records found.</td></tr>`;
    updateStatus("No data");
    return;
  }

  const latestId = data[0].id;
  
  // â­ DETECT NEW RECORDS
  if (lastRecordId !== null && latestId !== lastRecordId) {
    console.log(`ğŸ‰ NEW RECORD DETECTED! Old ID: ${lastRecordId} â†’ New ID: ${latestId}`);
    updateStatus(`âœ“ New data (ID: ${latestId})`);
    
    // Find new records
    const newRecords = data.filter(r => !knownRecordIds.has(r.id));
    if (newRecords.length > 0) {
      console.log(`Found ${newRecords.length} new records`);
    }
  } else {
    updateStatus(`âœ“ Monitoring (${pollCount})`);
  }

  lastRecordId = latestId;
  
  // Update known IDs
  knownRecordIds.clear();
  data.forEach(r => knownRecordIds.add(r.id));

  // Render table with highlighting for new records
  const isFirstLoad = pollCount === 1;
  tableBody.innerHTML = data.map(r => renderRow(r, !isFirstLoad && !knownRecordIds.has(r.id))).join("");
  
  updateLatestVitals(data);

  console.log(`[${new Date().toLocaleTimeString()}] Poll #${pollCount} - Latest ID: ${latestId}, Total: ${data.length}`);
}

// Polling control
function startPolling() {
  if (pollInterval) return;
  console.log("âœ… Started real-time monitoring");
  pollInterval = setInterval(loadHealthLogs, 2000);
}

function stopPolling() {
  if (!pollInterval) return;
  console.log("â¸ï¸ Stopped monitoring");
  clearInterval(pollInterval);
  pollInterval = null;
}

// Visibility detection
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    stopPolling();
    updateStatus("Paused");
  } else {
    updateStatus("Resuming...");
    loadHealthLogs();
    startPolling();
  }
});

window.addEventListener("focus", () => {
  updateStatus("Refreshing...");
  loadHealthLogs();
  startPolling();
});

window.addEventListener("blur", () => {
  stopPolling();
});

// Manual refresh
refreshBtn.addEventListener("click", () => {
  console.log("ğŸ”„ Manual refresh");
  updateStatus("Refreshing...");
  loadHealthLogs();
});

// Initial load
console.log("ğŸš€ Health logs page loaded");
loadHealthLogs();
startPolling();
</script>
<script src="logout.js"></script>
</body>
</html>