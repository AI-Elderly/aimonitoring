<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings | AI Health Monitor</title>

  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
</head>

<body>

  <!-- Back Button -->
  <button class="back-btn" onclick="window.location.href='dashboard.html'">â† Back</button>

  <div class="dashboard-container">
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <h2 class="logo">AI<span>Health</span></h2>
      <nav class="nav-links">
        <a href="./dashboard.html"><img src="dashboard.png" class="nav-icon"> Dashboard</a>
        <a href="./healthlogs.html">ğŸ“‹ Health Logs</a>
        <a href="./settings.html">âš™ï¸ Settings</a>
        <a href="device.html">ğŸ”Œ Device</a>
        <a href="./ai-assistant.html">
          <img src="chatbot.jpg" alt="Chatbot Icon" style="width:24px; height:24px; border-radius:50%; vertical-align:middle;">
          AlertoBot
        </a>
        <a href="./about.html">â„¹ï¸ About</a>
        <a href="#" id="logout-btn">ğŸšª Logout</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="dashboard-header">
        <h1>User Settings</h1>
        <p>Manage your account and preferences</p>
      </header>

      <!-- Settings Form -->
      <section class="settings-section">
        <form id="settings-form">

          <!-- Full Name -->
          <div class="input-group">
            <label>Full Name</label>
            <div class="flex-row">
              <input type="text" id="fullname" disabled />
              <button type="button" class="edit-btn" onclick="enableField('fullname')">Edit</button>
            </div>
          </div>

          <!-- Age -->
          <div class="input-group">
            <label>Age</label>
            <div class="flex-row">
              <input type="number" id="age" disabled min="1" max="120" />
              <button type="button" class="edit-btn" onclick="enableField('age')">Edit</button>
            </div>
          </div>

          <!-- Email -->
          <div class="input-group">
            <label>Email</label>
            <div class="flex-row">
              <input type="email" id="email" disabled />
              <button type="button" class="edit-btn" onclick="enableField('email')">Edit</button>
            </div>
          </div>

          <!-- Password -->
          <div class="input-group">
            <label>Password</label>
            <div class="flex-row">
              <input type="password" id="password" value="******" disabled />
              <button type="button" class="edit-btn" onclick="enableField('password')">Edit</button>
            </div>
          </div>

          <button type="submit" class="get-started-btn">ğŸ’¾ Save Changes</button>

        </form>
      </section>
    </main>
  </div>

<script>
const API_BASE = "https://semimaterialistic-hyperbolic-laverne.ngrok-free.dev";

// Load saved token

// Unlock a field for editing
function enableField(id) {
  const field = document.getElementById(id);
  if (id === "password") field.value = ""; // allow entering new password
  field.disabled = false;
  field.focus();
}

// Load user data on page load
document.addEventListener("DOMContentLoaded", () => {

  fetch(`${API_BASE}/user/settings`, {
    method: "GET",
    headers: {
      "Authorization": `Bearer ${token}`,
      "ngrok-skip-browser-warning": "true"
    }
  })
  .then(async res => {
    if (!res.ok) {
      // Token expired or invalid
      alert("Session expired. Please log in again.");
      localStorage.removeItem("token");
      window.location.href = "index.html";
      return;
    }
    return res.json();
  })
  .then(user => {
    if (!user) return;

    // Fill input fields with DB values
    document.getElementById("fullname").value = user.fullname || "";
    document.getElementById("age").value = user.age || "";
    document.getElementById("email").value = user.email || "";
    document.getElementById("password").value = "******";
  })
  .catch(err => {
    console.error("Error loading settings:", err);
    alert("Failed to load your information.");
  });

});


// Save updated settings
document.getElementById("settings-form").addEventListener("submit", (e) => {
  e.preventDefault();

  const payload = {
    fullname: document.getElementById("fullname").value,
    age: document.getElementById("age").value,
    email: document.getElementById("email").value
  };

  const pw = document.getElementById("password").value;
  if (pw !== "" && pw !== "******") {
    payload.password = pw;
  }

  fetch(`${API_BASE}/user/settings`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`,
      "ngrok-skip-browser-warning": "true"
    },
    body: JSON.stringify(payload)
  })
  .then(async res => {
    if (!res.ok) {
      alert("Could not update settings.");
      return;
    }
    return res.json();
  })
  .then(() => {
    alert("âœ… Settings updated successfully!");
    location.reload();
  })
  .catch(err => {
    console.error("Update error:", err);
    alert("Error updating settings.");
  });

});
</script>

<script src="device.js"></script>
<script src="logout.js"></script>

</body>
</html>
