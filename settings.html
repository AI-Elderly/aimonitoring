<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings | AI Health Monitor</title>

  <link rel="stylesheet" href="styles.css" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
</head>
<body>

  <!-- Back Button -->
  <button class="back-btn" onclick="window.location.href='dashboard.html'">â† Back</button>

  <div class="dashboard-container">
    
    <!-- Sidebar -->
    <aside class="sidebar">
      <h2 class="logo">AI<span>Health</span></h2>
      <nav class="nav-links">
        <a href="./dashboard.html"><img src="dashboard.png" class="nav-icon"> Dashboard</a>
        <a href="./healthlogs.html">ğŸ“‹ Health Logs</a>
        <a href="./settings.html">âš™ï¸ Settings</a>
        <a href="device.html">ğŸ”Œ Device</a>
        <a href="./ai-assistant.html">
          <img src="chatbot.jpg" alt="Chatbot Icon" style="width:24px; height:24px; border-radius:50%; vertical-align:middle;">
          AlertoBot
        </a>
        <a href="./about.html">â„¹ï¸ About</a>
        <a href="#" id="logout-btn">ğŸšª Logout</a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <header class="dashboard-header">
        <h1>User Settings</h1>
        <p>Manage your account and preferences</p>
      </header>

      <!-- Settings Form -->
      <section class="settings-section">
        <form id="settings-form">

          <div class="input-group">
            <label>Full Name</label>
            <div class="flex-row">
              <input type="text" id="fullname" disabled />
              <button type="button" class="edit-btn" onclick="enableField('fullname')">Edit</button>
            </div>
          </div>

          <div class="input-group">
            <label>Age</label>
            <div class="flex-row">
              <input type="number" id="age" disabled min="1" max="120" />
              <button type="button" class="edit-btn" onclick="enableField('age')">Edit</button>
            </div>
          </div>

          <div class="input-group">
            <label>Email</label>
            <div class="flex-row">
              <input type="email" id="email" disabled />
              <button type="button" class="edit-btn" onclick="enableField('email')">Edit</button>
            </div>
          </div>

          <div class="input-group">
            <label>Password</label>
            <div class="flex-row">
              <input type="password" id="password" value="******" disabled />
              <button type="button" class="edit-btn" onclick="enableField('password')">Edit</button>
            </div>
          </div>

          <button type="submit" class="get-started-btn">ğŸ’¾ Save Changes</button>

        </form>
      </section>
    </main>
  </div>

  <script>
const API_BASE = "https://semimaterialistic-hyperbolic-laverne.ngrok-free.dev";

// ----------------- Utility Functions -----------------

// Unlock a field for editing
function enableField(id) {
  const field = document.getElementById(id);
  if (id === "password") field.value = ""; // allow entering new password
  field.disabled = false;
  field.focus();
}

// Check if response is HTML (e.g., ngrok error page)
function isHTML(text) {
  return text.trim().startsWith("<!DOCTYPE html>") || text.trim().startsWith("<html");
}

// ----------------- Load User Settings -----------------
async function loadUserSettings() {
  const token = localStorage.getItem("token");
  if (!token) {
    alert("âš ï¸ You are not logged in. Redirecting to login page...");
    window.location.href = "login.html";
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/user/settings`, {
      method: "GET",
      headers: {
        "Authorization": `Bearer ${token}`,
        "ngrok-skip-browser-warning": "true"
      }
    });

    const text = await res.text();

    if (isHTML(text)) {
      console.error("Received HTML instead of JSON:", text);
      alert("âš ï¸ Server returned invalid response. Are you logged in?");
      return;
    }

    if (!res.ok) {
      if (res.status === 401) {
        alert("âš ï¸ Session expired. Please log in again.");
        localStorage.removeItem("token");
        window.location.href = "login.html";
      } else {
        console.error(`Server returned status ${res.status}:`, text);
        alert("Failed to load settings. Check console for details.");
      }
      return;
    }

    let user;
    try {
      user = JSON.parse(text);
    } catch (err) {
      console.error("Failed to parse JSON. Server returned:", text);
      alert("Invalid response from server.");
      return;
    }

    document.getElementById("fullname").value = user.fullname || "";
    document.getElementById("age").value = user.age || "";
    document.getElementById("email").value = user.email || "";
    document.getElementById("password").value = "******";

  } catch (err) {
    console.error("Fetch error:", err);
    alert("Error connecting to server. Check console for details.");
  }
}

// ----------------- Save Updated Settings -----------------
async function saveUserSettings(e) {
  e.preventDefault();

  const token = localStorage.getItem("token");
  if (!token) {
    alert("âš ï¸ You are not logged in. Redirecting to login page...");
    window.location.href = "login.html";
    return;
  }

  const payload = {
    fullname: document.getElementById("fullname").value,
    age: document.getElementById("age").value,
    email: document.getElementById("email").value
  };

  const pw = document.getElementById("password").value;
  if (pw !== "" && pw !== "******") payload.password = pw;

  try {
    const res = await fetch(`${API_BASE}/user/settings`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`,
        "ngrok-skip-browser-warning": "true"
      },
      body: JSON.stringify(payload)
    });

    const text = await res.text();

    if (isHTML(text)) {
      console.error("Received HTML instead of JSON:", text);
      alert("âš ï¸ Server returned invalid response. Settings not saved.");
      return;
    }

    if (!res.ok) {
      if (res.status === 401) {
        alert("âš ï¸ Session expired. Please log in again.");
        localStorage.removeItem("token");
        window.location.href = "index.html";
      } else {
        console.error(`Server returned status ${res.status}:`, text);
        alert("Could not update settings. Check console for details.");
      }
      return;
    }

    let data;
    try {
      data = JSON.parse(text);
    } catch {
      data = null; // ignore if no JSON returned
    }

    alert("âœ… Settings updated successfully!");
    location.reload();

  } catch (err) {
    console.error("Fetch error:", err);
    alert("Error updating settings.");
  }
}

// ----------------- Event Listeners -----------------
document.addEventListener("DOMContentLoaded", loadUserSettings);
document.getElementById("settings-form").addEventListener("submit", saveUserSettings);
</script>



  <script src="device.js"></script>
  <script src="logout.js"></script>

</body>
</html>
