<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard | AI Health Monitor</title>
<link rel="stylesheet" href="styles.css" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
<style>
.card .alert-badge {
  display: block !important;
  margin-top: 12px;
  font-size: 0.95rem;
  font-weight: 600;
  padding: 0;
  border-radius: 0;
  background: none !important;
  border: none !important;
  box-shadow: none !important;
}
.card .alert-badge.badge-normal { color: #3498db !important; }
.card .alert-badge.badge-warning { color: #e67e22 !important; }
.card .alert-badge.badge-critical { color: #e74c3c !important; }

/* Real-time indicator */
.realtime-indicator {
  position: fixed;
  top: 10px;
  right: 10px;
  background: rgba(0,0,0,0.8);
  color: #0f0;
  padding: 8px 15px;
  border-radius: 20px;
  font-size: 12px;
  font-family: monospace;
  z-index: 9999;
  display: flex;
  align-items: center;
  gap: 8px;
}
.realtime-indicator .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #0f0;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}
.realtime-indicator.updating .dot {
  background: #ff0;
  animation: blink 0.5s infinite;
}
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}
</style>
<script>
(function() {
  const theme = localStorage.getItem('theme') || 'light';
  if (theme === 'dark') document.documentElement.classList.add('dark-mode');
})();
</script>
</head>
<body>

<button class="back-btn" onclick="window.location.href='signin.html'">‚Üê Back</button>

<!-- Real-time Indicator -->
<div class="realtime-indicator" id="realtime-indicator">
  <div class="dot"></div>
  <span id="status-text">Checking...</span>
</div>

<div class="dashboard-container">
  <aside class="sidebar">
    <h2 class="logo">BELGIUM<span>sys</span></h2>
    <nav class="nav-links">
      <a href="./dashboard.html" class="active">
        <img src="dashboard.png" alt="Dashboard Icon" style="width:24px; height:24px; vertical-align:middle; margin-right:6px;"> Dashboard
      </a>
      <a href="./healthlogs.html">üìã Health Logs</a>
      <a href="./settings.html">‚öôÔ∏è Settings</a>
      <a href="./device.html">üîå Device</a>
      <a href="./ai-assistant.html">
        <img src="chatbot.jpg" alt="Chatbot Icon" style="width:24px; height:24px; border-radius:50%; vertical-align:middle;"> AlertoBot
      </a>
      <a href="./about.html">‚ÑπÔ∏è About</a>
      <a href="#" id="logout-btn">üö™ Logout</a>
    </nav>
  </aside>

  <main class="main-content">
    <header class="dashboard-header">
      <h1 id="welcome-text">Welcome, User üëã</h1>
      <p>Here's your latest health summary</p>
    </header>

    <section class="cards">
      <div class="card" id="hr-card">
        <h3>‚ù§Ô∏è Heart Rate</h3>
        <p class="value" id="hr-value">‚Äî <span>BPM</span></p>
        <span id="hr-badge" class="alert-badge badge-normal">Normal</span>
      </div>
      <div class="card" id="spo2-card">
        <h3>üå¨Ô∏è SpO‚ÇÇ</h3>
        <p class="value" id="spo2-value">‚Äî <span>%</span></p>
        <span id="spo2-badge" class="alert-badge badge-normal">Normal</span>
      </div>
    </section>

    <section class="chart-section">
      <h2>Health Progression Graph</h2>
      <div class="chart-container">
        <canvas id="healthChart"></canvas>
      </div>
    </section>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const API_URL = "https://semimaterialistic-hyperbolic-laverne.ngrok-free.dev";
const token = localStorage.getItem("access_token");
if (!token) window.location.href = "signin.html";

let pollInterval = null;
let lastRecordId = null;
let lastHeartRate = null;
let lastSpO2 = null;
let pollCount = 0;

const realtimeIndicator = document.getElementById("realtime-indicator");
const statusText = document.getElementById("status-text");

// Logout
document.getElementById("logout-btn").addEventListener("click", e => {
  e.preventDefault();
  localStorage.clear();
  window.location.href = "signin.html";
});

// Update status indicator
function updateStatus(status, isUpdating = false) {
  statusText.textContent = status;
  if (isUpdating) {
    realtimeIndicator.classList.add("updating");
  } else {
    realtimeIndicator.classList.remove("updating");
  }
}

// Fetch with forced cache bypass
async function fetchJSON(url, options = {}) {
  options.headers = { 
    ...(options.headers || {}), 
    "Authorization": `Bearer ${token}`, 
    "ngrok-skip-browser-warning": "true"
  };
  
  // Force cache bypass with random parameter
  const randomParam = Math.random().toString(36).substring(7);
  const cacheBuster = url.includes('?') ? `&_r=${randomParam}` : `?_r=${randomParam}`;
  const finalUrl = url + cacheBuster;
  
  try {
    const res = await fetch(finalUrl, {
      ...options,
      cache: 'no-store', // Force no caching
      headers: options.headers
    });
    
    const text = await res.text();
    
    try { 
      return { ok: res.ok, data: JSON.parse(text) }; 
    } catch { 
      console.error("Invalid JSON:", text.substring(0, 100));
      return { ok: false, error: "Invalid JSON" }; 
    }
  } catch (err) { 
    console.error("Fetch error:", err);
    return { ok: false, error: err.message }; 
  }
}

// Load user name
async function loadUserName() {
  const { ok, data } = await fetchJSON(`${API_URL}/user-info`);
  if (!ok) return;
  if (data.fullname) {
    document.getElementById("welcome-text").innerText = `Welcome, ${data.fullname.split(" ")[0]} üëã`;
  }
}

// Alert calculation
function getVitalAlert(vital, type) {
  if (vital === null || vital === undefined || vital === 0) return { level: 2, label: "No Signal" };
  if (type === "hr") {
    if (vital < 60 || vital > 100) return { level: 1, label: "Warning" };
  } else if (type === "spo2") {
    if (vital < 95) return { level: 1, label: "Warning" };
  }
  return { level: 0, label: "Normal" };
}

// Update badges
function updateBadges(hr, spo2) {
  const hrBadge = document.getElementById("hr-badge");
  const spo2Badge = document.getElementById("spo2-badge");

  const hrAlert = getVitalAlert(hr, "hr");
  const spo2Alert = getVitalAlert(spo2, "spo2");

  hrBadge.textContent = hrAlert.label;
  spo2Badge.textContent = spo2Alert.label;

  hrBadge.className = 'alert-badge';
  spo2Badge.className = 'alert-badge';

  hrBadge.classList.add(hrAlert.level===0?"badge-normal":hrAlert.level===1?"badge-warning":"badge-critical");
  spo2Badge.classList.add(spo2Alert.level===0?"badge-normal":spo2Alert.level===1?"badge-warning":"badge-critical");
}

// ‚≠ê CRITICAL: Load vitals with change detection
async function loadVitals() {
  pollCount++;
  updateStatus(`Checking... (${pollCount})`, true);
  
  const { ok, data } = await fetchJSON(`${API_URL}/healthlogs`);
  
  if (!ok) {
    updateStatus("Error fetching data", false);
    console.error("Failed to fetch vitals");
    return;
  }
  
  if (!Array.isArray(data) || !data.length) {
    updateStatus("No data available", false);
    console.warn("No data received");
    return;
  }

  const latest = data[0];
  const currentId = latest.id;
  const currentHR = latest.heart_rate ?? 0;
  const currentSpO2 = latest.spo2 ?? 0;

  // ‚≠ê DETECT CHANGES
  const hasNewData = lastRecordId !== currentId;
  const hasDataChanged = lastHeartRate !== currentHR || lastSpO2 !== currentSpO2;

  if (hasNewData) {
    console.log(`üéâ NEW RECORD! ID changed: ${lastRecordId} ‚Üí ${currentId}`);
    updateStatus(`‚úì Updated (ID: ${currentId})`, false);
  } else if (hasDataChanged) {
    console.log(`üìä DATA CHANGED! HR: ${lastHeartRate}‚Üí${currentHR}, SpO2: ${lastSpO2}‚Üí${currentSpO2}`);
    updateStatus(`‚úì Values changed`, false);
  } else {
    updateStatus(`‚úì Monitoring (${pollCount})`, false);
  }

  // ‚≠ê ALWAYS UPDATE UI (even if no changes, to handle initial load)
  lastRecordId = currentId;
  lastHeartRate = currentHR;
  lastSpO2 = currentSpO2;

  // Update display
  document.getElementById("hr-value").innerHTML = `${currentHR} <span>BPM</span>`;
  document.getElementById("spo2-value").innerHTML = `${currentSpO2}<span>%</span>`;

  updateBadges(currentHR, currentSpO2);
  updateChart(data);

  console.log(`[${new Date().toLocaleTimeString()}] Poll #${pollCount} - ID: ${currentId}, HR: ${currentHR}, SpO2: ${currentSpO2}`);
}

// Chart setup
const ctx = document.getElementById("healthChart").getContext("2d");
const isDarkMode = localStorage.getItem("theme")==="dark";
const healthChart = new Chart(ctx, {
  type: "line",
  data: {
    labels: [],
    datasets: [
      { label:"Heart Rate (BPM)", data:[], borderColor:"#ff4d6d", backgroundColor:"rgba(255,77,109,0.2)", tension:0.4, fill:false },
      { label:"SpO‚ÇÇ (%)", data:[], borderColor:"#00c853", backgroundColor:"rgba(0,200,83,0.2)", tension:0.4, fill:false }
    ]
  },
  options: {
    responsive:true,
    interaction:{mode:"index",intersect:false},
    plugins:{legend:{labels:{color:isDarkMode?"#fff":"#000",font:{size:13}}}},
    scales:{
      x:{ticks:{color:isDarkMode?"#fff":"#000"},grid:{color:isDarkMode?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}},
      y:{ticks:{color:isDarkMode?"#fff":"#000"},grid:{color:isDarkMode?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}}
    }
  }
});

// Update chart
function updateChart(records) {
  const last7 = records.slice(0,7).reverse();
  healthChart.data.labels = last7.map(r => {
    const date = new Date(r.timestamp);
    return date.toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});
  });
  healthChart.data.datasets[0].data = last7.map(r => r.heart_rate ?? 0);
  healthChart.data.datasets[1].data = last7.map(r => r.spo2 ?? 0);
  healthChart.update();
}

// Polling control
function startPolling() {
  if (pollInterval) return;
  console.log("‚úÖ Started real-time monitoring");
  pollInterval = setInterval(loadVitals, 2000); // Every 2 seconds
}

function stopPolling() {
  if (!pollInterval) return;
  console.log("‚è∏Ô∏è Stopped monitoring");
  clearInterval(pollInterval);
  pollInterval = null;
}

// Visibility detection
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    stopPolling();
    updateStatus("Paused (tab hidden)", false);
  } else {
    updateStatus("Resuming...", true);
    loadVitals();
    startPolling();
  }
});

window.addEventListener("focus", () => {
  updateStatus("Refreshing...", true);
  loadVitals();
  startPolling();
});

window.addEventListener("blur", () => {
  stopPolling();
});

// Initial load
document.addEventListener("DOMContentLoaded", () => {
  console.log("üöÄ Real-time Dashboard loaded");
  console.log(`API: ${API_URL}`);
  loadUserName();
  loadVitals();
  startPolling();
});
</script>
<script src="logout.js"></script>
</body>
</html>