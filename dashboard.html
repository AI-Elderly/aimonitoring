<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard | AI Health Monitor</title>
<link rel="stylesheet" href="styles.css" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
<style>
.card .alert-badge {
  display: block !important;
  margin-top: 12px;
  font-size: 0.95rem;
  font-weight: 600;
  padding: 0;
  border-radius: 0;
  background: none !important;
  border: none !important;
  box-shadow: none !important;
}
.card .alert-badge.badge-normal { color: #3498db !important; }
.card .alert-badge.badge-warning { color: #e67e22 !important; }
.card .alert-badge.badge-critical { color: #e74c3c !important; }

/* ESP32 Status Indicator */
.esp32-status {
  position: fixed;
  top: 10px;
  right: 10px;
  background: rgba(0,0,0,0.85);
  color: #0f0;
  padding: 10px 15px;
  border-radius: 8px;
  font-size: 12px;
  font-family: monospace;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 8px;
  min-width: 200px;
}
.esp32-status .status-row {
  display: flex;
  align-items: center;
  gap: 8px;
}
.esp32-status .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #0f0;
  animation: pulse 2s infinite;
}
.esp32-status .dot.disconnected {
  background: #f00;
  animation: none;
}
.esp32-status .dot.connecting {
  background: #ff0;
  animation: blink 0.5s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}
.esp32-toggle {
  background: #3498db;
  border: none;
  color: white;
  padding: 5px 10px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 11px;
  transition: background 0.3s;
}
.esp32-toggle:hover {
  background: #2980b9;
}
.esp32-toggle.active {
  background: #27ae60;
}
</style>
<script>
(function() {
  const theme = localStorage.getItem('theme') || 'light';
  if (theme === 'dark') document.documentElement.classList.add('dark-mode');
})();
</script>
</head>
<body>

<button class="back-btn" onclick="window.location.href='signin.html'">‚Üê Back</button>

<!-- ESP32 Status Panel -->
<div class="esp32-status" id="esp32-status">
  <div class="status-row">
    <div class="dot disconnected" id="esp32-dot"></div>
    <span id="esp32-text">ESP32: Disconnected</span>
  </div>
  <div class="status-row">
    <span id="data-status">Dashboard: Checking...</span>
  </div>
  <button class="esp32-toggle" id="esp32-toggle" onclick="toggleESP32()">Enable Auto-Connect</button>
</div>

<div class="dashboard-container">
  <aside class="sidebar">
    <h2 class="logo">BELGIUM<span>sys</span></h2>
    <nav class="nav-links">
      <a href="./dashboard.html" class="active">
        <img src="dashboard.png" alt="Dashboard Icon" style="width:24px; height:24px; vertical-align:middle; margin-right:6px;"> Dashboard
      </a>
      <a href="./healthlogs.html">üìã Health Logs</a>
      <a href="./settings.html">‚öôÔ∏è Settings</a>
      <a href="./device.html">üîå Device</a>
      <a href="./ai-assistant.html">
        <img src="chatbot.jpg" alt="Chatbot Icon" style="width:24px; height:24px; border-radius:50%; vertical-align:middle;"> AlertoBot
      </a>
      <a href="./about.html">‚ÑπÔ∏è About</a>
      <a href="#" id="logout-btn">üö™ Logout</a>
    </nav>
  </aside>

  <main class="main-content">
    <header class="dashboard-header">
      <h1 id="welcome-text">Welcome, User üëã</h1>
      <p>Here's your latest health summary</p>
    </header>

    <section class="cards">
      <div class="card" id="hr-card">
        <h3>‚ù§Ô∏è Heart</h3>
        <p class="value" id="hr-value">‚Äî <span>BPM</span></p>
        <span id="hr-badge" class="alert-badge badge-normal">Normal</span>
      </div>
      <div class="card" id="spo2-card">
        <h3>üå¨Ô∏è SpO‚ÇÇ</h3>
        <p class="value" id="spo2-value">‚Äî <span>%</span></p>
        <span id="spo2-badge" class="alert-badge badge-normal">Normal</span>
      </div>
    </section>

    <section class="chart-section">
      <h2>Health Progression Graph</h2>
      <div class="chart-container">
        <canvas id="healthChart"></canvas>
      </div>
    </section>
  </main>
</div>

<!-- Background ESP32 Service -->
<script src="esp32-background-service.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const API_URL = "https://semimaterialistic-hyperbolic-laverne.ngrok-free.dev";
const token = localStorage.getItem("access_token");
if (!token) window.location.href = "signin.html";

let pollInterval = null;
let lastRecordId = null;
let lastHeartRate = null;
let lastSpO2 = null;
let pollCount = 0;

const esp32Dot = document.getElementById("esp32-dot");
const esp32Text = document.getElementById("esp32-text");
const dataStatus = document.getElementById("data-status");
const esp32Toggle = document.getElementById("esp32-toggle");

// Toggle ESP32 auto-connect
function toggleESP32() {
  const status = window.ESP32BackgroundService.status();
  
  if (status.autoConnect) {
    window.ESP32BackgroundService.stop();
    esp32Toggle.textContent = "Enable Auto-Connect";
    esp32Toggle.classList.remove("active");
    esp32Text.textContent = "ESP32: Disabled";
    esp32Dot.classList.add("disconnected");
    alert("‚ùå ESP32 auto-connect disabled. Refresh page or click 'Enable' to reconnect.");
  } else {
    window.ESP32BackgroundService.start();
    esp32Toggle.textContent = "Disable Auto-Connect";
    esp32Toggle.classList.add("active");
    esp32Text.textContent = "ESP32: Connecting...";
    esp32Dot.classList.remove("disconnected");
    esp32Dot.classList.add("connecting");
    alert("‚úÖ ESP32 auto-connect enabled! Data will sync automatically in the background.");
  }
}

// Update ESP32 status indicator
setInterval(() => {
  const status = window.ESP32BackgroundService.status();
  
  if (status.connected) {
    esp32Text.textContent = `ESP32: Connected (${status.pollCount})`;
    esp32Dot.className = "dot";
  } else if (status.autoConnect) {
    esp32Text.textContent = "ESP32: Connecting...";
    esp32Dot.className = "dot connecting";
  } else {
    esp32Text.textContent = "ESP32: Disabled";
    esp32Dot.className = "dot disconnected";
  }
  
  // Update toggle button
  if (status.autoConnect) {
    esp32Toggle.textContent = "Disable Auto-Connect";
    esp32Toggle.classList.add("active");
  } else {
    esp32Toggle.textContent = "Enable Auto-Connect";
    esp32Toggle.classList.remove("active");
  }
}, 1000);

// Logout
document.getElementById("logout-btn").addEventListener("click", e => {
  e.preventDefault();
  localStorage.clear();
  window.location.href = "signin.html";
});

// Fetch data
async function fetchJSON(url, options = {}) {
  options.headers = { 
    ...(options.headers || {}), 
    "Authorization": `Bearer ${token}`, 
    "ngrok-skip-browser-warning": "true"
  };
  
  const randomParam = Math.random().toString(36).substring(7);
  const cacheBuster = url.includes('?') ? `&_r=${randomParam}` : `?_r=${randomParam}`;
  const finalUrl = url + cacheBuster;
  
  try {
    const res = await fetch(finalUrl, { ...options, cache: 'no-store' });
    const text = await res.text();
    return { ok: res.ok, data: JSON.parse(text) }; 
  } catch (err) { 
    return { ok: false, error: err.message }; 
  }
}

// Load user name
async function loadUserName() {
  const { ok, data } = await fetchJSON(`${API_URL}/user-info`);
  if (!ok) return;
  if (data.fullname) {
    document.getElementById("welcome-text").innerText = `Welcome, ${data.fullname.split(" ")[0]} üëã`;
  }
}

// Alert calculation
function getVitalAlert(vital, type) {
  if (vital === null || vital === undefined || vital === 0) return { level: 2, label: "No Signal" };
  if (type === "hr") {
    if (vital < 60 || vital > 100) return { level: 1, label: "Warning" };
  } else if (type === "spo2") {
    if (vital < 95) return { level: 1, label: "Warning" };
  }
  return { level: 0, label: "Normal" };
}

// Update badges
function updateBadges(hr, spo2) {
  const hrBadge = document.getElementById("hr-badge");
  const spo2Badge = document.getElementById("spo2-badge");

  const hrAlert = getVitalAlert(hr, "hr");
  const spo2Alert = getVitalAlert(spo2, "spo2");

  hrBadge.textContent = hrAlert.label;
  spo2Badge.textContent = spo2Alert.label;

  hrBadge.className = 'alert-badge';
  spo2Badge.className = 'alert-badge';

  hrBadge.classList.add(hrAlert.level===0?"badge-normal":hrAlert.level===1?"badge-warning":"badge-critical");
  spo2Badge.classList.add(spo2Alert.level===0?"badge-normal":spo2Alert.level===1?"badge-warning":"badge-critical");
}

// Load vitals
async function loadVitals() {
  pollCount++;
  dataStatus.textContent = `Dashboard: Checking... (${pollCount})`;
  
  const { ok, data } = await fetchJSON(`${API_URL}/healthlogs`);
  
  if (!ok || !Array.isArray(data) || !data.length) {
    dataStatus.textContent = "Dashboard: No data";
    return;
  }

  const latest = data[0];
  const currentId = latest.id;
  const currentHR = latest.heart_rate ?? 0;
  const currentSpO2 = latest.spo2 ?? 0;

  const hasNewData = lastRecordId !== currentId;

  if (hasNewData && lastRecordId !== null) {
    console.log(`üéâ NEW DATA! ID: ${lastRecordId} ‚Üí ${currentId}`);
    dataStatus.textContent = `Dashboard: ‚úì Updated (ID: ${currentId})`;
  } else {
    dataStatus.textContent = `Dashboard: ‚úì Monitoring (${pollCount})`;
  }

  lastRecordId = currentId;
  lastHeartRate = currentHR;
  lastSpO2 = currentSpO2;

  document.getElementById("hr-value").innerHTML = `${currentHR} <span>BPM</span>`;
  document.getElementById("spo2-value").innerHTML = `${currentSpO2}<span>%</span>`;

  updateBadges(currentHR, currentSpO2);
  updateChart(data);
}

// Chart setup
const ctx = document.getElementById("healthChart").getContext("2d");
const isDarkMode = localStorage.getItem("theme")==="dark";
const healthChart = new Chart(ctx, {
  type: "line",
  data: {
    labels: [],
    datasets: [
      { label:"Heart Rate (BPM)", data:[], borderColor:"#ff4d6d", backgroundColor:"rgba(255,77,109,0.2)", tension:0.4, fill:false },
      { label:"SpO‚ÇÇ (%)", data:[], borderColor:"#00c853", backgroundColor:"rgba(0,200,83,0.2)", tension:0.4, fill:false }
    ]
  },
  options: {
    responsive:true,
    interaction:{mode:"index",intersect:false},
    plugins:{legend:{labels:{color:isDarkMode?"#fff":"#000",font:{size:13}}}},
    scales:{
      x:{ticks:{color:isDarkMode?"#fff":"#000"},grid:{color:isDarkMode?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}},
      y:{ticks:{color:isDarkMode?"#fff":"#000"},grid:{color:isDarkMode?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}}
    }
  }
});

// Update chart
function updateChart(records) {
  const last7 = records.slice(0,7).reverse();
  healthChart.data.labels = last7.map(r => {
    const date = new Date(r.timestamp);
    return date.toLocaleDateString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"});
  });
  healthChart.data.datasets[0].data = last7.map(r => r.heart_rate ?? 0);
  healthChart.data.datasets[1].data = last7.map(r => r.spo2 ?? 0);
  healthChart.update();
}

// Polling control
function startPolling() {
  if (pollInterval) return;
  pollInterval = setInterval(loadVitals, 2000);
}

function stopPolling() {
  if (!pollInterval) return;
  clearInterval(pollInterval);
  pollInterval = null;
}

// Visibility detection
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    stopPolling();
  } else {
    loadVitals();
    startPolling();
  }
});

// Initial load
document.addEventListener("DOMContentLoaded", () => {
  console.log("üöÄ Dashboard with Background ESP32 Service loaded");
  loadUserName();
  loadVitals();
  startPolling();
});
</script>
<script src="logout.js"></script>
</body>
</html>