<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dashboard | AI Health Monitor</title>
<link rel="stylesheet" href="styles.css" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
<style>
.card .alert-badge {
  display: block !important;
  margin-top: 12px;
  font-size: 0.95rem;
  font-weight: 600;
  padding: 0;
  border-radius: 0;
  background: none !important;
  border: none !important;
  box-shadow: none !important;
}
.card .alert-badge.badge-normal { color: #3498db !important; }
.card .alert-badge.badge-warning { color: #e67e22 !important; }
.card .alert-badge.badge-critical { color: #e74c3c !important; }

/* DEBUG PANEL */
.debug-panel {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(0,0,0,0.9);
  color: #0f0;
  padding: 15px;
  border-radius: 8px;
  font-family: monospace;
  font-size: 12px;
  max-width: 400px;
  max-height: 300px;
  overflow-y: auto;
  z-index: 9999;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}
.debug-panel h4 {
  margin: 0 0 10px 0;
  color: #0ff;
  border-bottom: 1px solid #0ff;
  padding-bottom: 5px;
}
.debug-log {
  margin: 5px 0;
  padding: 5px;
  background: rgba(0,255,0,0.1);
  border-left: 3px solid #0f0;
}
.debug-error {
  color: #f00;
  background: rgba(255,0,0,0.1);
  border-left: 3px solid #f00;
}
.debug-success {
  color: #0f0;
}
.debug-warning {
  color: #ff0;
  background: rgba(255,255,0,0.1);
  border-left: 3px solid #ff0;
}
</style>
<script>
(function() {
  const theme = localStorage.getItem('theme') || 'light';
  if (theme === 'dark') document.documentElement.classList.add('dark-mode');
})();
</script>
</head>
<body>

<button class="back-btn" onclick="window.location.href='signin.html'">‚Üê Back</button>

<!-- DEBUG PANEL -->
<div class="debug-panel" id="debug-panel">
  <h4>üêõ Debug Console</h4>
  <div id="debug-logs"></div>
</div>

<div class="dashboard-container">
  <aside class="sidebar">
    <h2 class="logo">BELGIUM<span>sys</span></h2>
    <nav class="nav-links">
      <a href="./dashboard.html" class="active">
        <img src="dashboard.png" alt="Dashboard Icon" style="width:24px; height:24px; vertical-align:middle; margin-right:6px;"> Dashboard
      </a>
      <a href="./healthlogs.html">üìã Health Logs</a>
      <a href="./settings.html">‚öôÔ∏è Settings</a>
      <a href="./device.html">üîå Device</a>
      <a href="./ai-assistant.html">
        <img src="chatbot.jpg" alt="Chatbot Icon" style="width:24px; height:24px; border-radius:50%; vertical-align:middle;"> AlertoBot
      </a>
      <a href="./about.html">‚ÑπÔ∏è About</a>
      <a href="#" id="logout-btn">üö™ Logout</a>
    </nav>
  </aside>

  <main class="main-content">
    <header class="dashboard-header">
      <h1 id="welcome-text">Welcome, User üëã</h1>
      <p>Here's your latest health summary</p>
    </header>

    <section class="cards">
      <div class="card" id="hr-card">
        <h3>‚ù§Ô∏è Heart Rate</h3>
        <p class="value" id="hr-value">‚Äî <span>BPM</span></p>
        <span id="hr-badge" class="alert-badge badge-normal">Normal</span>
      </div>
      <div class="card" id="spo2-card">
        <h3>üå¨Ô∏è SpO‚ÇÇ</h3>
        <p class="value" id="spo2-value">‚Äî <span>%</span></p>
        <span id="spo2-badge" class="alert-badge badge-normal">Normal</span>
      </div>
    </section>

    <section class="chart-section">
      <h2>Health Progression Graph</h2>
      <div class="chart-container">
        <canvas id="healthChart"></canvas>
      </div>
    </section>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const API_URL = "https://semimaterialistic-hyperbolic-laverne.ngrok-free.dev";
const token = localStorage.getItem("access_token");
if (!token) window.location.href = "signin.html";

let pollInterval = null;
let lastRecordId = null;
let pollCount = 0;

// DEBUG LOGGER
const debugLogs = document.getElementById("debug-logs");
function debugLog(message, type = "log") {
  const time = new Date().toLocaleTimeString();
  const div = document.createElement("div");
  div.className = `debug-${type}`;
  div.textContent = `[${time}] ${message}`;
  debugLogs.insertBefore(div, debugLogs.firstChild);
  
  // Keep only last 20 logs
  while (debugLogs.children.length > 20) {
    debugLogs.removeChild(debugLogs.lastChild);
  }
  
  console.log(`[DEBUG ${type.toUpperCase()}]`, message);
}

// Logout
document.getElementById("logout-btn").addEventListener("click", e => {
  e.preventDefault();
  localStorage.clear();
  window.location.href = "signin.html";
});

// Enhanced fetch wrapper
async function fetchJSON(url, options = {}) {
  debugLog(`Fetching: ${url}`, "log");
  
  options.headers = { 
    ...(options.headers || {}), 
    "Authorization": `Bearer ${token}`, 
    "ngrok-skip-browser-warning": "true",
    "Cache-Control": "no-cache, no-store, must-revalidate",
    "Pragma": "no-cache",
    "Expires": "0"
  };
  
  try {
    // Add timestamp to prevent caching
    const cacheBuster = `?_t=${Date.now()}`;
    const finalUrl = url.includes('?') ? `${url}&_t=${Date.now()}` : `${url}${cacheBuster}`;
    
    const res = await fetch(finalUrl, options);
    const text = await res.text();
    
    try { 
      const data = JSON.parse(text);
      debugLog(`‚úì Received ${Array.isArray(data) ? data.length : 1} records`, "success");
      return { ok: res.ok, data }; 
    } catch { 
      debugLog(`‚úó Invalid JSON response`, "error");
      return { ok: false, error: "Invalid JSON", raw: text }; 
    }
  } catch (err) { 
    debugLog(`‚úó Fetch failed: ${err.message}`, "error");
    return { ok: false, error: "Fetch failed", raw: err }; 
  }
}

// Load user name
async function loadUserName() {
  const { ok, data } = await fetchJSON(`${API_URL}/user-info`);
  if (!ok) return;
  if (data.fullname) {
    document.getElementById("welcome-text").innerText = `Welcome, ${data.fullname.split(" ")[0]} üëã`;
    debugLog(`User: ${data.fullname}`, "success");
  }
}

// Determine alert for individual vital
function getVitalAlert(vital, type) {
  if (vital === null || vital === undefined || vital === 0) return { level: 2, label: "Critical (No Signal)" };
  if (type === "hr") {
    if (vital < 60 || vital > 100) return { level: 1, label: "Warning" };
  } else if (type === "spo2") {
    if (vital < 95) return { level: 1, label: "Warning" };
  }
  return { level: 0, label: "Normal" };
}

// Update badges
function updateBadges(hr, spo2) {
  const hrBadge = document.getElementById("hr-badge");
  const spo2Badge = document.getElementById("spo2-badge");

  const hrAlert = getVitalAlert(hr, "hr");
  const spo2Alert = getVitalAlert(spo2, "spo2");

  hrBadge.textContent = hrAlert.label;
  spo2Badge.textContent = spo2Alert.label;

  hrBadge.className = 'alert-badge';
  spo2Badge.className = 'alert-badge';

  hrBadge.classList.add(hrAlert.level===0?"badge-normal":hrAlert.level===1?"badge-warning":"badge-critical");
  spo2Badge.classList.add(spo2Alert.level===0?"badge-normal":spo2Alert.level===1?"badge-warning":"badge-critical");
}

// Load latest vitals
async function loadVitals() {
  pollCount++;
  debugLog(`Poll #${pollCount} - Fetching vitals...`, "log");
  
  const { ok, data } = await fetchJSON(`${API_URL}/healthlogs`);
  
  if (!ok) {
    debugLog("Failed to fetch vitals", "error");
    return;
  }
  
  if (!Array.isArray(data) || !data.length) {
    debugLog("No data received", "warning");
    return;
  }

  const latest = data[0];
  const currentRecordId = latest.id;
  
  // Check if this is new data
  if (lastRecordId === null) {
    debugLog(`Initial record ID: ${currentRecordId}`, "success");
  } else if (currentRecordId !== lastRecordId) {
    debugLog(`üéâ NEW DATA! Old ID: ${lastRecordId} ‚Üí New ID: ${currentRecordId}`, "success");
  } else {
    debugLog(`Same record ID: ${currentRecordId} (no new data)`, "warning");
  }
  
  lastRecordId = currentRecordId;

  const hrValue = latest.heart_rate ?? 0;
  const spo2Value = latest.spo2 ?? 0;
  
  debugLog(`HR: ${hrValue} bpm | SpO‚ÇÇ: ${spo2Value}% | Time: ${latest.timestamp}`, "success");

  // Update values
  document.getElementById("hr-value").innerHTML = `${hrValue} <span>BPM</span>`;
  document.getElementById("spo2-value").innerHTML = `${spo2Value}<span>%</span>`;

  // Update badges
  updateBadges(hrValue, spo2Value);

  // Update chart
  updateChart(data);
}

// Chart setup
const ctx = document.getElementById("healthChart").getContext("2d");
const isDarkMode = localStorage.getItem("theme")==="dark";
const healthChart = new Chart(ctx, {
  type: "line",
  data: {
    labels: [],
    datasets: [
      { label:"Heart Rate (BPM)", data:[], borderColor:"#ff4d6d", backgroundColor:"rgba(255,77,109,0.2)", tension:0.4, fill:false },
      { label:"SpO‚ÇÇ (%)", data:[], borderColor:"#00c853", backgroundColor:"rgba(0,200,83,0.2)", tension:0.4, fill:false }
    ]
  },
  options: {
    responsive:true,
    interaction:{mode:"index",intersect:false},
    plugins:{legend:{labels:{color:isDarkMode?"#fff":"#000",font:{size:13}}}},
    scales:{
      x:{ticks:{color:isDarkMode?"#fff":"#000"},grid:{color:isDarkMode?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}},
      y:{ticks:{color:isDarkMode?"#fff":"#000"},grid:{color:isDarkMode?"rgba(255,255,255,0.1)":"rgba(0,0,0,0.1)"}}
    }
  }
});

// Update chart data
function updateChart(records) {
  const last7 = records.slice(0,7).reverse();
  healthChart.data.labels = last7.map(r => new Date(r.timestamp).toLocaleDateString("en-US",{month:"short",day:"numeric"}));
  healthChart.data.datasets[0].data = last7.map(r => r.heart_rate ?? 0);
  healthChart.data.datasets[1].data = last7.map(r => r.spo2 ?? 0);
  healthChart.update();
}

// Start/Stop polling
function startPolling() {
  if (pollInterval) return;
  debugLog("‚úÖ Started polling (every 2 seconds)", "success");
  pollInterval = setInterval(loadVitals, 2000);
}

function stopPolling() {
  if (!pollInterval) return;
  debugLog("‚è∏Ô∏è Stopped polling", "warning");
  clearInterval(pollInterval);
  pollInterval = null;
}

// Visibility change detection
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    debugLog("Page hidden - stopping poll", "warning");
    stopPolling();
  } else {
    debugLog("Page visible - refreshing immediately", "success");
    loadVitals();
    startPolling();
  }
});

// Focus detection
window.addEventListener("focus", () => {
  debugLog("Window focused - refreshing", "success");
  loadVitals();
  startPolling();
});

window.addEventListener("blur", () => {
  debugLog("Window blurred - stopping poll", "warning");
  stopPolling();
});

// Initial load
document.addEventListener("DOMContentLoaded", () => {
  debugLog("üöÄ Dashboard loaded", "success");
  debugLog(`API: ${API_URL}`, "log");
  debugLog(`Token: ${token ? 'Present' : 'Missing'}`, token ? "success" : "error");
  
  loadUserName();
  loadVitals();
  startPolling();
});
</script>
<script src="logout.js"></script>
</body>
</html>